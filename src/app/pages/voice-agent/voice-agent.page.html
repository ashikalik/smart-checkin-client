<ion-header>
  <ion-toolbar>
    <span
      class="connection-dot"
      [class.connected]="voiceAgent.status() === 'connected'"
      [class.disconnected]="voiceAgent.status() === 'disconnected'"
      slot="start"
    ></span>
    <ion-badge class="mode-badge" slot="start" *ngIf="voiceAgent.mode() === 'listening'">
      <span class="mode-dots">
        <span class="dot"></span>
        <span class="dot"></span>
        <span class="dot"></span>
      </span>
    </ion-badge>
    <ion-badge class="mode-badge" slot="start" *ngIf="voiceAgent.mode() === 'speaking'">
      <ion-icon name="volume-high"></ion-icon>
    </ion-badge>
    <ion-title>Smart Check In</ion-title>
    <ion-button slot="end" fill="clear" size="small" (click)="toggleSession()">
      <ion-icon
        [name]="voiceAgent.status() === 'connected' || voiceAgent.status() === 'connecting' ? 'stop-circle' : 'play-circle'"
      ></ion-icon>
    </ion-button>
  </ion-toolbar>
</ion-header>

<ion-content class="voice-agent-content" [fullscreen]="true" scrollY="true" scrollEvents="true" (ionScroll)="onContentScroll($event)">
  <div class="status-bar">
    <!-- <ion-text *ngIf="voiceAgent.conversationId()" class="conversation-id">{{ voiceAgent.conversationId() }}</ion-text> -->
  </div>

  <ion-list class="message-list">
    <ion-item
      *ngFor="let item of displayItems; trackBy: trackByIndex"
      class="message-item"
      [class.user-bubble]="asMessage(item)?.role === 'user'"
      [class.journey-card-item]="asMessage(item)?.type === 'journey-card' || asMessage(item)?.type === 'passenger-list' || asMessage(item)?.type === 'boarding-pass'"
    >
      <ion-label>
        <ng-container *ngIf="item.type === 'message'">
          <ng-container *ngIf="asMessage(item)?.type === 'journey-card'; else passengerOrText">
            <div class="journey-wrapper">
              <app-journey-card [data]="asJourneyData(asMessage(item))!"></app-journey-card>
            </div>
          </ng-container>
          <ng-template #passengerOrText>
            <ng-container *ngIf="asMessage(item)?.type === 'passenger-list'; else boardingOrText">
              <div class="journey-wrapper">
                <app-passenger-list-card [data]="asPassengerData(asMessage(item))!"></app-passenger-list-card>
              </div>
            </ng-container>
            <ng-template #boardingOrText>
              <ng-container *ngIf="asMessage(item)?.type === 'boarding-pass'; else textMessage">
                <div class="journey-wrapper">
                  <app-boarding-pass-carousel [data]="asBoardingPassData(asMessage(item))!"></app-boarding-pass-carousel>
                </div>
              </ng-container>
              <ng-template #textMessage>
                <div class="bubble" [class.user]="asMessage(item)?.role === 'user'">
                  <p class="message-text">{{ asMessage(item)?.text }}</p>
                </div>
              </ng-template>
            </ng-template>
          </ng-template>
        </ng-container>

        <ng-container *ngIf="item.type === 'live-user'">
          <div class="bubble user live">
            <ng-container *ngIf="asLiveText(item); else userDots">
              <p class="message-text">{{ asLiveText(item) }}</p>
            </ng-container>
            <ng-template #userDots>
              <ion-spinner name="dots" class="live-dots"></ion-spinner>
            </ng-template>
          </div>
        </ng-container>

        <ng-container *ngIf="item.type === 'live-agent'">
          <div class="bubble live">
            <ng-container *ngIf="asLiveText(item); else agentDots">
              <p class="message-text">{{ asLiveText(item) }}</p>
            </ng-container>
            <ng-template #agentDots>
              <ion-spinner name="dots" class="live-dots"></ion-spinner>
            </ng-template>
          </div>
        </ng-container>
      </ion-label>
    </ion-item>
  </ion-list>

  <ion-button
    *ngIf="hasNewMessages"
    class="new-message-indicator"
    size="small"
    (click)="jumpToLatest()"
  >
    New message
  </ion-button>
</ion-content>

<ion-footer>
  <div class="input-row">
    <ion-input
      [(ngModel)]="inputText"
      placeholder="Type a message"
      (keyup.enter)="sendMessage()"
    ></ion-input>
    <ion-button class="footer-send" fill="clear" (click)="sendMessage()" [disabled]="voiceAgent.isSending() || !inputText.trim()">
      <ion-icon [name]="'play-circle'"></ion-icon>
    </ion-button>
  </div>
</ion-footer>
